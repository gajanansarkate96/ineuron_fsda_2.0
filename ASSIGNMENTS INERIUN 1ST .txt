/*GAJANAN SARKATE
gajanansarkate96@gmail.com*/;

USE INEURON_ASSIGNMENTS;
USE DATABASE ASSIGNMENTS_GD;

/* __________________________________ ANSWER 1 __________________________________ */

-- 1. Load the given dataset into snowflake with a primary key to Order Date column;

-- DROP TABLE IF EXISTS GD_SALES_DATA;
CREATE OR REPLACE TABLE GD_SALES_DATA
							 (order_id VARCHAR(40),
							  order_date VARCHAR(15) NOT NULL PRIMARY KEY,
							  ship_date VARCHAR(15),
							  ship_mode VARCHAR(20),
							  customer_name VARCHAR(40),
							  segment VARCHAR(40),
							  state VARCHAR(40),
							  country VARCHAR(40),
							  market VARCHAR(40),
							  region VARCHAR(40),
							  product_id VARCHAR(50),
							  category VARCHAR(40),
							  sub_category VARCHAR(40),
							  product_name VARCHAR2(200),
							  sales NUMBER(20,4),
							  quantity NUMBER(10,4),
							  discount NUMBER(10,4),
							  profit NUMBER(10,4),
							  shipping_cost NUMBER(10,4),
							  order_priority CHAR(20),
							  year INTEGER
							  );
                              
SELECT GET_DDL('Table', 'GD_SALES_DATA');

SELECT *
FROM GD_SALES_DATA;

-- DROP TABLE IF EXISTS GD_SALES_COPY;

CREATE OR REPLACE TABLE GD_SALES_COPY LIKE GD_SALES_DATA; -- Copy architecture of the database;

SELECT GET_DDL('Table', 'GD_SALES_COPY');

CREATE OR REPLACE TABLE GD_SALES_COPY AS SELECT * FROM GD_SALES_DATA; -- Copy of original dataset;

SELECT *
FROM GD_SALES_COPY;

DESCRIBE TABLE GD_SALES_COPY; -- Verify Order_Date is PRIMARY KEY of the table;
-- OR 
SHOW PRIMARY KEYS IN GD_SALES_COPY; -- It shows only primary key of the database i.e., ORDER_DATE;

-- #NOTE: We create a copy of original data and now work on copy dataset.

/* __________________________________ ANSWER 2 __________________________________ */

-- 2. Change the Primary key to Order Id Column.


ALTER TABLE GD_SALES_COPY
DROP PRIMARY KEY;          -- Only one primary key possible on the table, so we need to drop it first and then add accordingly.

ALTER TABLE GD_SALES_COPY 
ADD PRIMARY KEY (ORDER_ID); -- Now, make a primary key to order_ID beacuse it does not accept the any duplicate and NULL values.

SHOW PRIMARY KEYS IN GD_SALES_COPY; -- Primary key is set for ORDER_ID;
-- OR
DESCRIBE TABLE GD_SALES_COPY; -- Full description of the dataset;

SELECT GET_DDL('Table', 'GD_SALES_COPY'); -- Scroll down, you can see primary key is set for order_id

/* __________________________________ ANSWER 3 __________________________________ */

-- 3. Check the data type for Order date and Ship date and mention in what data type it should be?

DESCRIBE TABLE GD_SALES_COPY;
-- OR
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'PUBLIC' AND TABLE_NAME = 'GD_SALES_COPY' AND (COLUMN_NAME = 'ORDER_DATE' OR COLUMN_NAME = 'SHIP_DATE');

-- The above code check and indiactes that the column ORDER_DATE and SHIP_DATE is TEXT i.e., VARCHAR.

-- Thus, the ORDER_DATE and SHIP_DATE should be in DATE FORMAT but it is in VARCHAR.
-- Therefore, we need to change it from VARCHAR TO DATE.

CREATE OR REPLACE TABLE GD_SALES_COPY AS SELECT *, TO_DATE(ORDER_DATE, 'YYYY-MM-DD') AS ORDER_DATE_NEW,
                                                   TO_DATE(SHIP_DATE, 'YYYY-MM-DD') AS SHIP_DATE_NEW
                                         FROM GD_SALES_DATA;


SELECT *
FROM GD_SALES_COPY;

ALTER TABLE GD_SALES_COPY 
ADD PRIMARY KEY (ORDER_ID);

DESCRIBE TABLE GD_SALES_COPY; -- ORDER_DATE and SHIP_DATE is in DATE FORMAT.
-- OR
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'PUBLIC' AND TABLE_NAME = 'GD_SALES_COPY' AND (COLUMN_NAME = 'ORDER_DATE_NEW' OR COLUMN_NAME = 'SHIP_DATE_NEW');

ALTER TABLE GD_SALES_COPY
DROP COLUMN ORDER_DATE, SHIP_DATE; -- We can drop both of these columns from the table beacuse we have replica of these two columns.

DESCRIBE TABLE GD_SALES_COPY;


-- Now, ORDER_DATE and SHIP_DATE is in "DATE" FORMAT.

/* __________________________________ ANSWER 4__________________________________ */

-- 4. Create a new column called order_extract and extract the number after the last ‘–‘from Order ID column.

ALTER TABLE GD_SALES_COPY
ADD COLUMN ORDER_EXTRACT INT;

-- Extracting the last number using SPLIT_PART () or SUBSTR () function both work in same way.

SELECT SPLIT_PART(ORDER_ID,'-',3) AS SPLIT_ID,
       SUBSTR(ORDER_ID, 9) AS SUBSTR_ID
FROM GD_SALES_COPY;

-- NOW, updating a new column ORDER_EXTRACT.

UPDATE GD_SALES_COPY
SET ORDER_EXTRACT = SPLIT_PART(ORDER_ID,'-',3);

SELECT ORDER_ID, ORDER_EXTRACT
FROM GD_SALES_COPY;

/* __________________________________ ANSWER 5 __________________________________ */;

/* 5. Create a new column called Discount Flag and categorize it based on discount.
Use ‘Yes’ if the discount is greater than zero else ‘No’ */



ALTER TABLE GD_SALES_COPY
ADD COLUMN DISCOUNT_FLAG VARCHAR(5);

UPDATE GD_SALES_COPY
SET DISCOUNT_FLAG = (CASE
                         WHEN DISCOUNT > 0 THEN 'YES'
                         ELSE 'NO'
                     END);
                     
SELECT *
FROM GD_SALES_COPY;

/* __________________________________ ANSWER 6 __________________________________ */;

/* 6. Create a new column called process days and
      calculate how many days it takes for each order id to process from the order to its shipment */
      

ALTER TABLE GD_SALES_COPY
ADD COLUMN PROCESS_DAY INT;


UPDATE GD_SALES_COPY
SET PROCESS_DAY = (DATEDIFF(DAYS, ORDER_DATE_NEW, SHIP_DATE_NEW)); -- FROM Order_Date to SHIP_DATE;

SELECT ORDER_DATE_NEW, SHIP_DATE_NEW, PROCESS_DAY
FROM GD_SALES_COPY;

/* __________________________________ ANSWER 7 __________________________________ */;

/* 7. Create a new column called Rating and then based on the Process dates give rating like given below.
        a. If process days less than or equal to 3 days then rating should be 5
        b. If process days are greater than 3 and less than or equal to 6 then rating should be 4
        c. If process days are greater than 6 and less than or equal to 10 then rating should be 3
        d. If process days are greater than 10 then the rating should be 2. */;
        

ALTER TABLE GD_SALES_COPY
ADD COLUMN Rating INT;


UPDATE GD_SALES_COPY
SET Rating = (CASE
                  WHEN PROCESS_DAY <=3 THEN 5
                  WHEN PROCESS_DAY > 3 AND PROCESS_DAY <= 6 THEN 4
                  WHEN PROCESS_DAY > 6 AND PROCESS_DAY <= 10 THEN 3
                  WHEN PROCESS_DAY > 10 THEN 2
                  ELSE PROCESS_DAY
              END);


SELECT DISTINCT PROCESS_DAY, RATING
FROM GD_SALES_COPY
ORDER BY PROCESS_DAY ASC;  -- Verification via Mapping.

